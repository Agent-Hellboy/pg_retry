name: PostgreSQL Extension CI

# Tests the pg_retry PostgreSQL extension across multiple PostgreSQL versions
# Builds the extension, installs it, and runs regression tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        postgresql: [14, 15, 16, 17]
        # PostgreSQL 18 can be added when postgres:18 Docker image becomes available

    services:
      postgres:
        image: postgres:${{ matrix.postgresql }}
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Install PostgreSQL development headers
      run: |
        # Add PostgreSQL APT repository for newer versions
        sudo apt-get install -y wget ca-certificates gnupg lsb-release
        wget -O- https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor | sudo tee /usr/share/keyrings/postgresql.gpg > /dev/null
        echo "deb [signed-by=/usr/share/keyrings/postgresql.gpg arch=$(dpkg --print-architecture)] http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/postgresql.list
        sudo apt-get update
        sudo apt-get install -y postgresql-server-dev-${{ matrix.postgresql }} build-essential

    - name: Create test database
      run: |
        PGPASSWORD=postgres psql -h postgres -U postgres -c "CREATE DATABASE pg_retry_test;"

    - name: Build extension
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.postgresql }}/bin:$PATH"
        export PG_CONFIG="/usr/lib/postgresql/${{ matrix.postgresql }}/bin/pg_config"
        make clean
        make

    - name: Install extension
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.postgresql }}/bin:$PATH"
        sudo make install

    - name: Verify extension installation
      run: |
        PGPASSWORD=postgres psql -h postgres -U postgres -d pg_retry_test -c "SELECT * FROM pg_available_extensions WHERE name = 'pg_retry';"

    - name: Run regression tests
      run: |
        export PATH="/usr/lib/postgresql/${{ matrix.postgresql }}/bin:$PATH"
        export PG_CONFIG="/usr/lib/postgresql/${{ matrix.postgresql }}/bin/pg_config"
        export PGHOST=postgres
        export PGUSER=postgres
        export PGPASSWORD=postgres
        export PGDATABASE=pg_retry_test
        make installcheck

    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-pg${{ matrix.postgresql }}
        path: |
          regression.diffs
          regression.out
          results/
